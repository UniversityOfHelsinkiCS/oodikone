name: Run end-to-end tests with Cypress

on:
  push:
    paths:
      - .github/workflows/cypress.yaml
      - cypress.json
      - cypress/**
      - services/**
      - package*.json

jobs:
  build:
    name: "Build images"
    runs-on: ubuntu-latest
    env:
      TAG: trunk
      CACHE_TAG: trunk
    steps:
      - name: Checkout repo
        uses: actions/checkout@v2
      - name: Build images for services
        run: docker-compose -f docker-compose.ci.yml build --parallel
      - name: Save built images
        run: |
          docker save toska/oodikone2-analytics:trunk -o /tmp/analytics.tar
          docker save toska/oodikone2-backend:trunk -o /tmp/backend.tar
          docker save toska/oodikone2-frontend:trunk -o /tmp/frontend.tar
          docker save toska/oodikone2-userservice:trunk -o /tmp/userservice.tar
      - name: Upload images for next jobs
        uses: actions/upload-artifact@v2
        with:
          name: Docker images
          path: /tmp/*.tar

  test:
    needs: build
    name: "Run cypress tests"
    runs-on: ubuntu-latest
    env:
      TAG: trunk
      CACHE_TAG: trunk
    steps:
      - name: Checkout repo
        uses: actions/checkout@v2
      - name: Login to toska docker registry
        uses: docker/login-action@v1
        with:
          registry: registry.toska.cs.helsinki.fi
          username: ${{ secrets.TOSKAREGISTRY_USERNAME }}
          password: ${{ secrets.TOSKAREGISTRY_PASSWORD }}
      - name: Download built images
        uses: actions/download-artifact@v2
        with:
          name: Docker images
          path: /tmp
      - name: Load built images
        run: |
          docker load --input /tmp/analytics.tar
          docker load --input /tmp/backend.tar
          docker load --input /tmp/frontend.tar
          docker load --input /tmp/userservice.tar
      - name: Pull other needed images
        run: docker-compose -f docker-compose.ci.yml pull --ignore-pull-failures
      - name: Run services
        run: docker-compose -f docker-compose.ci.yml up -d
      - name: Cypress run
        uses: cypress-io/github-action@v2
        with:
          browser: chrome
      - name: Upload video
        uses: actions/upload-artifact@v2
        if: failure()
        with:
          name: Cypress videos
          path: ./cypress/videos/*
