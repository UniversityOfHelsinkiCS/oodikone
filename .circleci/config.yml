version: 2.1
orbs:
  cypress: cypress-io/cypress@1.8.0
executors:
  base10-custom-url:
    docker:
      - image: 'cypress/base:10'
    environment:
      CYPRESS_baseUrl: http://localhost:1337/
jobs:
  build:
    docker:
      - image: circleci/node:10.15.3
    steps:
      - setup_remote_docker
      - run: docker --version
      - run: docker-compose --version
      - checkout
      - run: echo 'export IMAGE=CIRCLE' >> $BASH_ENV
      - run: echo 'export TAG=circle' >> $BASH_ENV
      - run: docker pull node:10.15-alpine
      - run: docker-compose -f docker-compose.yml -f ./docker/docker-compose.lateste2e.yml build --parallel

      - run: git clone git@github.com:UniversityOfHelsinkiCS/anonyymioodi.git
      - run: docker-compose -f docker-compose.yml -f ./docker/docker-compose.lateste2e.yml up -d db user_db db_kone
      - run: source ./scripts/scripts.sh && db_anon_setup_full && init_dirs
      - run: docker-compose -f docker-compose.yml -f ./docker/docker-compose.lateste2e.yml up -d --no-recreate
      - run: docker ps
      - run: docker-compose -f docker-compose.yml -f ./docker/docker-compose.lateste2e.yml logs
      - run: npm run test_services
      - cypress/run:
          executor: base10-custom-url
          store_artifacts: true

      - run: docker ps -a
      - run: if [[ $(docker ps --all | grep -Eo '(Exited|Restarting) \([0-9]+\)' | grep -Eo '[0-9]+' | awk 'BEGIN {sum=0} { sum += $1 } END { print sum }') != '0' ]]; then echo 'Some process had nonzero exit code'; exit 1; fi
